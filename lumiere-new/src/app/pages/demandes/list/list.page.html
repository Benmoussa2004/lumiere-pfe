<ion-header class="ion-no-border">
  <div class="premium-header-glass">
    <ion-toolbar class="main-toolbar">
      <ion-buttons slot="start">
        <ion-back-button defaultHref="/home" icon="arrow-back-outline"></ion-back-button>
      </ion-buttons>
      <ion-title>Suivi des Ordres</ion-title>
      <ion-buttons slot="end">
        <ion-button (click)="createNewDemande()" class="add-btn">
          <ion-icon slot="icon-only" name="add-outline"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>

    <div class="header-controls">
      <div class="search-bar-modern">
        <ion-icon name="search-outline"></ion-icon>
        <input type="text" [ngModel]="searchTerm" (input)="onSearch($event)"
          placeholder="Rechercher un client, une ville...">
      </div>

      <div class="filter-actions mt-3">
        <div class="segment-pill-container">
          <ion-segment [(ngModel)]="listMode" (ionChange)="onModeChange()" class="compact-segment">
            <ion-segment-button value="confirmed">Confirmés</ion-segment-button>
            <ion-segment-button value="draft">Brouillons</ion-segment-button>
          </ion-segment>
        </div>
        <div class="status-select-container">
          <ion-select [(ngModel)]="selectedStatut" (ionChange)="onStatutChange($event)" placeholder="Statut"
            interface="popover" class="compact-select" [disabled]="listMode === 'draft'">
            <ion-select-option *ngFor="let option of statutOptions" [value]="option.value">
              {{ option.label }}
            </ion-select-option>
          </ion-select>
        </div>
        <ion-button fill="clear" (click)="resetFilters()" class="mini-reset-btn">
          <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
    </div>
  </div>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="refreshData($event)">
    <ion-refresher-content pullingIcon="chevron-down-outline" refreshingSpinner="circles"></ion-refresher-content>
  </ion-refresher>

  <div class="main-container">
    <!-- Skeleton Loading State -->
    <div *ngIf="loading" class="skeleton-container">
      <div *ngFor="let s of skeletonCount" class="skeleton-card">
        <div class="skele-header">
          <div class="skele-chip"></div>
          <div class="skele-pill"></div>
        </div>
        <div class="skele-body">
          <div class="skele-avatar"></div>
          <div class="skele-lines">
            <div class="line w-40"></div>
            <div class="line w-60"></div>
          </div>
        </div>
        <div class="skele-journey">
          <div class="point"></div>
          <div class="bar"></div>
          <div class="point"></div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && demandes.length === 0" class="pro-empty-state">
      <div class="empty-media">
        <div class="icon-ring">
          <ion-icon name="document-text-outline"></ion-icon>
        </div>
      </div>
      <h2>Aucun ordre trouvé</h2>
      <p>Commencez par créer un nouvel ordre de transport.</p>
      <ion-button (click)="createNewDemande()" shape="round" class="create-first-btn">
        Nouveau Ordre
      </ion-button>
    </div>

    <!-- Orders Grid -->
    <div class="orders-timeline" *ngIf="!loading && demandes.length > 0">
      <div *ngFor="let d of demandes" class="pro-order-card" (click)="viewDetails(d)">
        <div class="card-status-indicator" [class]="d.statut.toLowerCase()"></div>

        <div class="card-inner">
          <div class="top-row">
            <div class="order-ref">
              <span class="prefix">ORD</span>
              <span class="number">#{{ d.id }}</span>
            </div>
            <div class="status-badge" [class]="d.statut.toLowerCase()">
              {{ getStatusLabel(d.statut) }}
            </div>
          </div>

          <div class="client-row mt-3">
            <div class="avatar-ring" [class]="d.statut.toLowerCase()">
              {{ (d.client || 'C').charAt(0).toUpperCase() }}
            </div>
            <div class="client-meta">
              <h3>{{ d.client }}</h3>
              <div class="sub-meta" *ngIf="d.matricule">
                <ion-icon name="car-outline"></ion-icon>
                <span>{{ d.matricule }}</span>
              </div>
            </div>
            <div class="order-date">
              {{ formatDate(d.dateSaisie || d.chargementDate) }}
            </div>
          </div>

          <div class="journey-viewer mt-4">
            <div class="journey-point from">
              <div class="node"></div>
              <div class="details">
                <span class="loc">{{ d.chargementVille }}</span>
                <span class="label">Chargement</span>
              </div>
            </div>

            <div class="journey-connector">
              <div class="line"></div>
              <ion-icon name="chevron-forward-outline" class="dir-icon"></ion-icon>
            </div>

            <div class="journey-point to">
              <div class="node"></div>
              <div class="details">
                <span class="loc">{{ d.livraisonVille }}</span>
                <span class="label">Livraison</span>
              </div>
            </div>
          </div>

          <div class="bottom-stats mt-4">
            <div class="stats-group">
              <div class="stat">
                <ion-icon name="layers-outline"></ion-icon>
                <span>{{ d.nombrePalettes }} Pal</span>
              </div>
              <div class="stat-divider"></div>
              <div class="stat">
                <ion-icon name="cube-outline"></ion-icon>
                <span>{{ d.nombreColis }} Col</span>
              </div>
            </div>

            <div class="pro-actions">
              <ion-button fill="clear" color="primary" (click)="editDemande(d, $event)">
                <ion-icon name="create-outline" slot="icon-only"></ion-icon>
              </ion-button>
              <ion-button fill="clear" color="danger" (click)="deleteDemande(d, $event)">
                <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ion-infinite-scroll *ngIf="!loading && demandes.length > 0" (ionInfinite)="loadMore($event)" threshold="100px">
    <ion-infinite-scroll-content loadingSpinner="crescent"></ion-infinite-scroll-content>
  </ion-infinite-scroll>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed" class="safe-margin">
    <ion-fab-button class="lumiere-fab" (click)="createNewDemande()">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>